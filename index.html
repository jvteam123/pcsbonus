<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCS Advanced Bonus Calculator</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ua-parser-js@0.7.32/src/ua-parser.min.js"></script>

   <link rel="stylesheet" href="style.css?v=1.3">
    <script>
        // Custom Tailwind theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-900': '#1F1D2B', 'brand-800': '#252836', 'brand-700': '#393C49',
                        'brand-600': '#4F5B6A', 'brand-400': '#ABBBC2', 'brand-300': '#FFFFFF',
                        'accent': { 'DEFAULT': '#6C5ECF', 'hover': '#584BAF' },
                        'status-red': '#FF7CA3', 'status-green': '#50D1AA', 'status-orange': '#FFB572',
                        'status-yellow': '#FDC57B',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-brand-900 text-brand-300 font-sans antialiased">

    <div id="user-update-banner" class="hidden fixed top-0 left-0 right-0 bg-accent text-white p-3 text-center z-50 flex justify-center items-center gap-4">
        <span id="update-banner-text">A new update is available for the calculation settings.</span>
        <button id="accept-update-btn" class="btn-secondary bg-white/20 hover:bg-white/30 border-white/30 text-white py-1 px-3">Accept Update</button>
    </div>

    <div id="spotlight-overlay" class="hidden"></div>

    <div id="update-notification" class="hidden fixed top-5 right-5 bg-accent text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-all duration-300">
        Notification message.
    </div>

    <div class="w-full max-w-screen-2xl mx-auto p-4 md:p-6">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl md:text-2xl font-bold text-white">PCS Bonus Calculator V2</h1>
            <div class="relative" id="main-menu-container">
                <button id="main-menu-btn" class="menu-btn" aria-label="Main Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg>
                    <span>Menu</span>
                </button>
                <div id="main-menu-dropdown" class="absolute right-0 mt-2 w-56 bg-brand-800 border border-brand-700 rounded-md shadow-lg z-20 hidden">
                    <a href="#" id="guided-setup-btn" class="dropdown-item">Guided Setup</a>
                    <a href="#" id="manage-teams-btn" class="dropdown-item">Manage Teams</a>
                    <a href="#" id="advance-settings-btn" class="dropdown-item">Advance Settings</a>
                    <a href="#" id="admin-portal-btn" class="dropdown-item">Admin Portal</a>
                    <a href="#" id="toggle-theme-btn" class="dropdown-item">Toggle Theme</a>
                    <div class="border-t border-brand-700 my-1"></div>
                    <a href="#" id="important-info-btn" class="dropdown-item">Important Information</a>
                    <a href="#" id="bug-report-btn" class="dropdown-item">Report a Bug</a>
                    <div class="border-t border-brand-700 my-1"></div>
                    <a href="#" id="clear-data-btn" class="dropdown-item text-red-400 hover:bg-red-500/20">Clear All Data</a>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:items-start">
            
            <div id="data-projects-panel" class="dashboard-panel flex flex-col">
                <div class="panel-header flex justify-between items-center">
                    <h2 class="panel-title">Data & Projects</h2>
                    <button id="update-online-btn" title="Sync projects from cloud" class="btn-secondary py-1 px-2 text-sm update-online-btn">
                        <svg id="update-online-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                        <span>Update online</span>
                    </button>
                </div>
                <div class="p-4 space-y-4 flex-grow overflow-y-auto custom-scrollbar min-h-0">
                    <div>
                        <div class="flex items-center gap-2">
                            <select id="project-select" class="input-field w-full"><option value="">Select a project...</option></select>
                            <span id="project-ir-badge" class="project-info-badge hidden"></span>
                            <div id="project-loading-spinner" class="hidden"><div class="pulsing-spinner"></div></div>
                            <button id="refresh-projects-btn" title="Refresh Project List" class="control-btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg></button>
                            <button id="edit-data-btn" title="Edit Selected Project" class="control-btn-icon hidden"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                            <button id="delete-project-btn" title="Delete Selected Project" class="control-btn-icon-danger"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                        </div>
                    </div>

                    <div id="drop-zone" class="p-4 text-center border-2 border-dashed border-brand-700 rounded-lg hover:border-accent transition-colors">
                        <textarea id="project-data" rows="8" class="input-field w-full font-mono text-sm custom-scrollbar" placeholder="Paste data or drag & drop Fix folder files here..."></textarea>
                        <div class="mt-2 text-sm text-brand-400">Supported formats: TSV/CSV text or Fix Folder files (.shp/.dbf).</div>
                    </div>

                    <div class="flex items-center gap-4 mt-4 p-4 rounded-lg bg-brand-800 border border-brand-700">
                        <label for="project-name" class="text-sm font-medium whitespace-nowrap">Project Name:</label>
                        <input type="text" id="project-name" class="input-field w-full" placeholder="Project Name">
                    </div>
                    
                    <div class="flex flex-wrap gap-4 mt-4 p-4 rounded-lg bg-brand-800 border border-brand-700">
                        <div class="flex items-center gap-2">
                            <label for="gsd-value-select" class="text-sm font-medium">GSD:</label>
                            <select id="gsd-value-select" class="input-field text-sm">
                                <option value="3in">3in</option>
                                <option value="4in">4in</option>
                                <option value="6in">6in</option>
                                <option value="9in">9in</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="is-ir-project-checkbox" type="checkbox" class="h-4 w-4 text-accent focus:ring-accent bg-brand-700 border-brand-600 rounded">
                            <label for="is-ir-project-checkbox" class="text-sm font-medium text-accent">IR Project</label>
                        </div>
                        <div id="tech-id-override-container" class="flex items-center gap-2">
                            <label for="tech-id-override" class="text-sm font-medium">Override ID:</label>
                            <input type="text" id="tech-id-override" class="input-field text-sm w-20" placeholder="1234AB">
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        <button id="save-project-btn" class="btn-primary w-full text-base">Save Project</button>
                        <button id="clear-data-btn-local" class="btn-secondary w-full">Clear Data</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div id="calculation-controls-panel" class="dashboard-panel mb-6">
                    <div class="panel-header">
                        <h2 class="panel-title">Calculation Controls</h2>
                    </div>
                    <div class="p-4 flex flex-wrap items-end gap-4">
                        <div class="flex-grow">
                            <label for="project-combined-select" class="block text-sm font-medium text-brand-400 mb-1">Combine Projects</label>
                            <select id="project-combined-select" class="input-field w-full" multiple size="3"></select>
                            <p id="combined-project-info" class="text-xs text-brand-400 mt-1 hidden"></p>
                        </div>
                        <div class="flex-shrink-0">
                            <button id="calculate-combined-btn" class="btn-primary" disabled>Calculate Combined</button>
                        </div>
                    </div>
                    <div class="border-t border-brand-700 pt-4 mt-4 space-y-4">
                        <input type="number" id="bonusMultiplierDirect" class="input-field w-full" placeholder="Bonus Multiplier (e.g., 9)">
                        <div class="space-y-3">
                            <button id="calculate-btn" class="btn-primary w-full text-base">Calculate All</button>
                            <div class="flex items-center">
                                <input id="customize-calc-all-cb" type="checkbox" class="h-4 w-4 text-accent focus:ring-accent bg-brand-700 border-brand-600 rounded">
                                <label for="customize-calc-all-cb" class="ml-2 text-sm font-medium text-brand-400">Customize Calculation (Experimental)</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="bonus-payout-section" class="dashboard-panel hidden">
                    <div class="panel-header">
                        <h2 id="results-title" class="panel-title">Bonus Payouts</h2>
                        <div class="flex items-center gap-2">
                            <button id="filter-reset-btn" title="Reset Filters and Search" class="btn-secondary py-1 px-2 text-sm">Reset</button>
                            <button id="export-csv-btn" title="Export Results to CSV" class="btn-secondary py-1 px-2 text-sm">Export CSV</button>
                        </div>
                    </div>
                    
                    <div class="p-4 border-b border-brand-700 flex flex-wrap items-center gap-4">
                        <div id="team-filter-container" class="flex flex-wrap items-center gap-3">
                            <span class="text-sm font-medium text-brand-300">Filter by Team:</span>
                            <button id="refresh-teams-btn" title="Refresh Teams" class="control-btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg></button>
                        </div>
                        <input type="text" id="tech-search-input" class="input-field w-32 ml-auto" placeholder="Search Tech ID">
                    </div>

                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="sortable-header" data-sort="id">ID</th>
                                    <th class="sortable-header" data-sort="points">Points</th>
                                    <th class="sortable-header" data-sort="fixTasks">Tasks</th>
                                    <th class="sortable-header" data-sort="refixTasks">Refix</th>
                                    <th class="sortable-header" data-sort="quality">Quality</th>
                                    <th class="sortable-header" data-sort="bonusEarned">Bonus %</th>
                                    <th class="sortable-header sort-desc" data-sort="payout">Payout</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="tech-results-tbody">
                                </tbody>
                        </table>
                    </div>
                    
                    <div id="quick-summary-card" class="p-4 border-t border-brand-700 mt-4 space-y-3">
                        <h3 class="text-lg font-bold text-white mb-2">Project Summary</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="quick-summary-container">
                            </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div id="leaderboard-panel" class="dashboard-panel flex flex-col">
                        <div class="panel-header">
                            <h2 class="panel-title">Leaderboard</h2>
                        </div>
                        <div class="p-4 flex items-center gap-2 border-b border-brand-700">
                            <label for="leaderboard-sort-select" class="text-sm font-medium text-brand-400">Sort by:</label>
                            <select id="leaderboard-sort-select" class="input-field text-sm w-auto">
                                <option value="payout">Payout</option>
                                <option value="totalPoints">Points</option>
                                <option value="fixTasks">Fix Tasks</option>
                                <option value="fixQuality">Quality</option>
                            </select>
                            <button id="leaderboard-refresh-btn" class="control-btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg></button>
                        </div>
                        <div class="overflow-y-auto custom-scrollbar flex-grow">
                            <table class="min-w-full">
                                <thead>
                                    <tr>
                                        <th class="w-1/4">Rank</th>
                                        <th class="w-1/4">ID</th>
                                        <th class="w-1/2" id="leaderboard-metric-header">Payout</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-body">
                                    <tr><td class="p-4 text-center text-brand-400" colspan="3">Calculate results to see data.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tl-summary-card" class="dashboard-panel flex flex-col hidden">
                        <div class="panel-header">
                            <h2 class="panel-title">Team Leader Summary</h2>
                            <button id="tl-refresh-btn" class="control-btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg></button>
                        </div>
                        <div class="p-4 space-y-4 flex-grow overflow-y-auto custom-scrollbar">
                            <div id="team-quality-container" class="space-y-3">
                                </div>
                            <div id="fix4-breakdown-container" class="space-y-3 mt-4">
                                <h3 class="text-lg font-bold text-white border-t border-brand-700 pt-4">Fix Category 4 (Combined)</h3>
                                </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
        <style>
        .clickable-metric {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: #6C5ECF; /* accent color */
            text-underline-offset: 3px;
            transition: color 0.1s ease-in-out;
        }
        .clickable-metric:hover {
            color: #ABBBC2; /* brand-400 (light gray) */
        }
        </style>

        <div id="metric-breakdown-modal" class="hidden fixed inset-0 bg-brand-900/75 z-50 flex justify-center items-center p-4">
            <div class="bg-brand-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-brand-700">
                    <h3 id="metric-breakdown-modal-title" class="text-lg font-semibold text-white">Metric Breakdown</h3>
                    <button class="modal-close-btn text-brand-400 hover:text-white" onclick="document.getElementById('metric-breakdown-modal').classList.add('hidden')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar flex-grow" id="metric-breakdown-modal-body">
                    </div>
            </div>
        </div>

        <div id="team-summary-modal" class="hidden fixed inset-0 bg-brand-900/75 z-50 flex justify-center items-center p-4">
            <div class="bg-brand-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-brand-700">
                    <h3 id="team-summary-modal-title" class="text-lg font-semibold text-white">Team Summary</h3>
                    <button class="modal-close-btn text-brand-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar" id="team-summary-modal-body">
                    </div>
            </div>
        </div>

        <div id="tech-summary-modal" class="hidden fixed inset-0 bg-brand-900/75 z-50 flex justify-center items-center p-4">
            <div class="bg-brand-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-brand-700">
                    <h3 id="tech-summary-modal-title" class="text-lg font-semibold text-white">Tech Details</h3>
                    <button class="modal-close-btn text-brand-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar" id="tech-summary-modal-body">
                    </div>
            </div>
        </div>

        <div id="manage-teams-modal" class="hidden fixed inset-0 bg-brand-900/75 z-50 flex justify-center items-center p-4">
            <div class="bg-brand-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-brand-700">
                    <h3 class="text-lg font-semibold text-white">Manage Teams</h3>
                    <button class="modal-close-btn text-brand-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar flex-grow">
                    <div class="flex items-center justify-between mb-4">
                        <button id="add-team-btn" class="btn-secondary">Add New Team</button>
                        <button id="reset-teams-btn" class="btn-secondary text-red-400 hover:bg-red-500/20">Reset to Defaults</button>
                    </div>
                    <div id="team-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                </div>
                <div class="p-4 border-t border-brand-700">
                    <button id="save-teams-btn" class="btn-primary w-full">Save Teams</button>
                </div>
            </div>
        </div>

        <div id="advance-settings-modal" class="hidden fixed inset-0 bg-brand-900/75 z-50 flex justify-center items-center p-4">
            <div class="bg-brand-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-brand-700">
                    <h3 class="text-lg font-semibold text-white">Advance Settings</h3>
                    <button class="modal-close-btn text-brand-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar flex-grow" id="advance-settings-body">
                    </div>
                <div class="p-4 border-t border-brand-700 flex justify-end gap-2">
                    <button id="reset-advance-settings-btn" class="btn-secondary text-red-400 hover:bg-red-500/20">Reset to Defaults</button>
                    <button id="save-advance-settings-btn" class="btn-primary">Save Settings</button>
                </div>
            </div>
        </div>

        <div id="admin-portal-modal" class="hidden fixed inset-0 bg-brand-900/75 z-50 flex justify-center items-center p-4">
            <div class="bg-brand-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-brand-700">
                    <h3 class="text-lg font-semibold text-white">Admin Portal</h3>
                    <button class="modal-close-btn text-brand-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar flex-grow">
                    <div class="flex items-center gap-2 border-b border-brand-700 mb-4">
                        <button class="tab-button active" data-tab="admin-projects">Projects</button>
                        <button class="tab-button" data-tab="admin-users" id="admin-users-tab">Users</button>
                        <button class="tab-button" data-tab="admin-logs">Logs</button>
                    </div>

                    <div id="admin-projects" class="admin-tab-content active">
                        <div id="admin-project-form-container" class="mb-6 p-4 border border-brand-700 rounded-lg">
                            <h4 id="admin-form-title" class="text-xl font-bold mb-4">Add New Project</h4>
                            <input type="hidden" id="admin-project-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <input type="text" id="admin-project-name" class="input-field" placeholder="Project Name">
                                <select id="admin-gsd-select" class="input-field text-sm">
                                    <option value="3in">3in GSD</option>
                                    <option value="4in">4in GSD</option>
                                    <option value="6in">6in GSD</option>
                                    <option value="9in">9in GSD</option>
                                </select>
                                <div class="flex items-center gap-2 col-span-full">
                                    <input id="admin-is-ir-checkbox" type="checkbox" class="h-4 w-4 text-accent focus:ring-accent bg-brand-700 border-brand-600 rounded">
                                    <label for="admin-is-ir-checkbox" class="text-sm font-medium text-accent">IR Project</label>
                                </div>
                            </div>
                            <div id="admin-drop-zone" class="p-4 text-center border-2 border-dashed border-brand-700 rounded-lg hover:border-accent transition-colors mt-4">
                                <textarea id="admin-project-data" rows="8" class="input-field w-full font-mono text-sm custom-scrollbar" placeholder="Paste data or drag & drop Fix folder files here..."></textarea>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <button id="admin-save-project-btn" class="btn-primary w-full text-base">Save to Cloud</button>
                                <button id="admin-reset-form-btn" class="btn-secondary w-full hidden">Cancel</button>
                            </div>
                        </div>

                        <h4 class="text-xl font-bold mb-4">Cloud Projects</h4>
                        <div class="overflow-x-auto custom-scrollbar">
                            <table class="min-w-full">
                                <thead>
                                    <tr>
                                        <th>Project Name</th>
                                        <th>GSD</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-project-list-tbody">
                                    <tr><td colspan="4" class="text-center p-4 text-brand-400">Loading projects...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="admin-users" class="admin-tab-content hidden">
                        <h4 class="text-xl font-bold mb-4">User Management</h4>
                        <div id="user-management-container">
                            <p class="text-brand-400">Loading user data...</p>
                        </div>
                    </div>

                    <div id="admin-logs" class="admin-tab-content hidden">
                        <h4 class="text-xl font-bold mb-4">Visitor Logs</h4>
                        <div class="overflow-x-auto custom-scrollbar">
                            <table class="min-w-full">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>User Agent</th>
                                        <th>Browser</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-log-tbody">
                                    <tr><td colspan="3" class="text-center p-4 text-brand-400">Loading logs...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="guided-setup-modal" class="hidden fixed inset-0 bg-brand-900/75 z-50 flex justify-center items-center p-4">
            <div class="bg-brand-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-brand-700">
                    <h3 class="text-lg font-semibold text-white">Guided Setup</h3>
                    <button class="modal-close-btn text-brand-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar flex-grow">
                    <div id="setup-step-indicator" class="flex justify-center items-center gap-4 mb-6">
                        </div>
                    <div id="setup-content-container">
                        </div>
                </div>
                <div class="p-4 border-t border-brand-700 flex justify-between">
                    <button id="setup-prev-btn" class="btn-secondary" disabled>Previous</button>
                    <button id="setup-next-btn" class="btn-primary">Next</button>
                </div>
            </div>
        </div>

        <div id="merge-fp-modal" class="hidden fixed inset-0 bg-brand-900/75 z-50 flex justify-center items-center p-4">
            <div class="bg-brand-800 rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-brand-700">
                    <h3 class="text-lg font-semibold text-white">Merge Partials FP</h3>
                    <button class="modal-close-btn text-brand-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar">
                    <div id="merge-drop-zone" class="p-10 text-center border-2 border-dashed border-brand-700 rounded-lg hover:border-accent transition-colors">
                        <p class="text-brand-400">Drag and drop **partial** Fix folder files here (.shp/.dbf)</p>
                    </div>
                    <div id="merge-info-container" class="mt-4 p-4 rounded-lg bg-brand-900 border border-brand-700 hidden">
                        <h4 class="font-bold text-white mb-2">Files to Merge:</h4>
                        <ul id="merge-file-list" class="list-disc list-inside text-sm text-brand-400 space-y-1"></ul>
                    </div>
                </div>
                <div class="p-4 border-t border-brand-700">
                    <button id="execute-merge-btn" class="btn-primary w-full" disabled>Merge and Populate Data</button>
                </div>
            </div>
        </div>
        
        <div id="important-info-modal" class="hidden fixed inset-0 bg-brand-900/75 z-50 flex justify-center items-center p-4">
            <div class="bg-brand-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-brand-700">
                    <h3 class="text-lg font-semibold text-white">Important Information</h3>
                    <button class="modal-close-btn text-brand-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar space-y-4" id="important-info-body">
                    <div class="info-section">
                        <h4 class="info-title">Calculation Logic</h4>
                        <p class="info-text">This calculator is based on the formulas and tables provided in the "Phili IC Fixpoints App Documentation v1.0." The logic employed in all calculations is designed to be transparent and accurate according to this official documentation.</p>
                    </div>
                    <div class="info-section">
                        <h4 class="info-title">Bonus Tier Table</h4>
                        <table class="info-table w-full text-sm">
                            <thead><tr><th>Quality %</th><th>Bonus Multiplier</th><th>Quality %</th><th>Bonus Multiplier</th></tr></thead>
                            <tbody id="bonus-tier-info-tbody">
                                </tbody>
                        </table>
                    </div>
                    <div class="info-section">
                        <h4 class="info-title">Points by Category (3in GSD default)</h4>
                        <table class="info-table w-full text-sm">
                            <thead><tr><th>Category</th><th>Points</th><th>Category</th><th>Points</th></tr></thead>
                            <tbody id="category-points-info-tbody">
                                </tbody>
                        </table>
                        <p class="text-xs text-brand-400 mt-2">Note: This table shows default 3in GSD values. Check 'Advance Settings' for other GSD values and QC/i3QA/RV point values.</p>
                    </div>
                    <div class="info-section">
                        <h4 class="info-title">Counting Logic Triggers</h4>
                        <p class="info-text">The following labels/columns trigger penalties:</p>
                        <ul class="list-disc list-inside text-sm text-brand-400 space-y-1 mt-2">
                            <li>**Refix (i)**: Increases Refix count in columns: rv1_label, rv2_label, rv3_label.</li>
                            <li>**Miss (m, c)**: Increases Warnings count in columns: i3qa_label, rv1_label, rv2_label, rv3_label.</li>
                            <li>**Warning (b, c, d, e, f, g, i)**: Increases Warnings count in columns: r1_warn, r2_warn, r3_warn, r4_warn.</li>
                            <li>**QC Penalty (m, e)**: Triggers an additional QC Task penalty in column: i3qa_label.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="script.js?v=1.3"></script>

    <script>
        // Initialize listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            UI.initListeners();
            App.init();
        });
    </script>
    <div id="chatbot-container" class="fixed bottom-5 right-5 z-50">
    <div id="chatbot-bubble" class="w-16 h-16 bg-accent rounded-full flex items-center justify-center cursor-pointer shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="white" viewBox="0 0 16 16">
            <path d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9.06 9.06 0 0 0 8 15z"/>
        </svg>
    </div>
    <div id="chatbot-window" class="hidden absolute bottom-20 right-0 w-80 h-96 bg-brand-800 rounded-lg shadow-2xl flex flex-col border border-brand-700">
        <div class="p-3 border-b border-brand-700 flex justify-between items-center">
            <span class="font-semibold text-white">FixPoints Chatbot</span>
            <button id="chatbot-close-btn" class="text-brand-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.647 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
            </button>
        </div>
        <div id="chatbot-messages" class="flex-grow p-3 space-y-2 overflow-y-auto custom-scrollbar">
            </div>
        <div class="p-3 border-t border-brand-700">
            <input type="text" id="chatbot-input" class="input-field w-full" placeholder="Ask about the calculator...">
        </div>
    </div>
    </div>
</body>
</html>
